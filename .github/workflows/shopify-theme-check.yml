name: Theme Check

on:
  pull_request:
    paths:
      - 'layout/**'
      - 'templates/**'
      - 'sections/**'
      - 'snippets/**'
      - 'assets/**'
      - 'config/**'
      - 'locales/**'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  theme-check:
    name: Theme Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Shopify CLI
        run: npm install -g @shopify/cli @shopify/theme

      - name: Run Theme Check
        id: theme-check
        continue-on-error: true
        run: |
          # Increase Node.js memory limit to 4GB
          export NODE_OPTIONS="--max-old-space-size=4096"

          # Run theme check, excluding live-theme-check directory
          shopify theme check --exclude "live-theme-check/**"

      - name: Comment results on PR
        if: always()
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const fs = require('fs');
              let message = '## üîç Theme Check Results\n\n';

              // Use the outcome of the theme-check step
              const checkStatus = '${{ steps.theme-check.outcome }}';

              if (checkStatus === 'success') {
                message += '‚úÖ All theme checks passed!';
              } else {
                message += '‚ö†Ô∏è Theme check found some warnings. Please review the workflow logs for details.\n\n';
                message += 'Note: The theme is still deployable. Most warnings are recommendations for best practices.';
              }

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: message
              });
            } catch (error) {
              console.log('Could not comment on PR:', error.message);
              console.log('This is expected if the GitHub token lacks permissions.');
            }
